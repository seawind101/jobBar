<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Post</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
</head>

<body style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
  " class="post-job-page">
    <nav class="top-controls">
        <button onclick="location.href='/companies'"
            style="border: 1px solid <%= company.bsColor %>;">Companies</button>
        <button onclick="location.href='/allJobs'" style="border: 1px solid <%= company.bsColor %>;">All Jobs</button>
        <button onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'"
            style="border: 1px solid <%= company.bsColor %>;">Job Page</button>
    </nav>

    <div class="container">
        <div class="post-card">
            <h1>Post a Job for <%= company.name %>
            </h1>
            <form id="jobpost-form" action="/jobPosts" method="POST">
                <input type="hidden" name="company" value="<%= company.name %>">
                <div class="form-row">
                    <label for="title">Job Title:</label>
                    <input type="text" id="title" name="title" maxlength="100" required>
                </div>
                <div class="form-row">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" maxlength="200" required></textarea>
                </div>
                <div class="form-row">
                    <label for="link">GitHub Issue Link:</label>
                    <input type="url" id="link" name="link" required>
                </div>
                <div class="form-row">
                    <label for="pay">Pay:</label>
                    <input type="number" id="pay" name="pay" required>
                </div>
                <input type="hidden" name="status" value="available">
                <button type="submit"
                    style="background-color: <%= company.pColor %>; color: <%= company.bpColor %>; border: 1px solid <%= company.bpColor %>;">Submit</button>
            </form>

            <!-- PIN modal -->
            <style>
                /* minimal modal styles kept local to this template */
                #pin-modal {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.6);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                }

                .pin-modal-content {
                    background: linear-gradient(180deg, var(--bg-b), #3a1224);
                    padding: 1.25rem;
                    border-radius: 12px;
                    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
                    width: 360px;
                    max-width: 92%;
                    color: var(--muted);
                    text-align: center;
                }

                .pin-modal-content h3 {
                    margin: 0 0 0.5rem 0;
                }

                .pin-modal-content input {
                    font-size: 1.15rem;
                    padding: 0.6rem;
                    width: 100%;
                    margin: 0.6rem 0;
                    border-radius: 8px;
                    border: 1px solid rgba(255, 255, 255, 0.06);
                    background: rgba(255, 255, 255, 0.02);
                    color: var(--muted);
                }

                .pin-actions {
                    display: flex;
                    gap: 0.5rem;
                    justify-content: flex-end;
                    margin-top: 0.5rem
                }

                .pin-actions button {
                    padding: 0.45rem 0.8rem;
                    border-radius: 8px;
                    border: none;
                    cursor: pointer
                }

                #pin-cancel {
                    background: transparent;
                    color: var(--muted);
                    border: 1px solid rgba(255, 255, 255, 0.04);
                }

                #pin-confirm {
                    background: var(--accent);
                    color: #fff;
                }
            </style>

            <div id="pin-modal">
                <div class="pin-modal-content" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
                    <h3 id="pin-modal-title">Cost: <%= typeof JPOST !=='undefined' ? JPOST : 100 %>
                    </h3>
                    <h3 id="pin-modal-title">Enter your PIN</h3>
                    <input id="pin-input" type="password" maxlength="6" inputmode="numeric" pattern="[0-9]*"
                        placeholder="••••••" autocomplete="one-time-code" />
                    <div class="pin-actions">
                        <button id="pin-cancel" type="button">Cancel</button>
                        <button id="pin-confirm" type="button">Confirm</button>
                    </div>
                </div>
            </div>

            <script>
                (function () {
                    const form = document.getElementById('jobpost-form');
                    if (!form) return;

                    const modal = document.getElementById('pin-modal');
                    const pinInput = document.getElementById('pin-input');
                    const btnCancel = document.getElementById('pin-cancel');
                    const btnConfirm = document.getElementById('pin-confirm');

                    // Get company name from the page
                    const companyName = '<%= company.name %>';

                    // allow Enter key in PIN field to confirm
                    pinInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') { e.preventDefault(); btnConfirm.click(); }
                    });

                    function showModal() {
                        pinInput.value = '';
                        modal.style.display = 'flex';
                        setTimeout(() => pinInput.focus(), 50);
                    }
                    function hideModal() {
                        modal.style.display = 'none';
                        btnConfirm.disabled = false;
                        btnConfirm.textContent = 'Confirm';
                    }

                    async function awaitConfirm() {
                        return new Promise((resolve) => {
                            const cleanup = () => {
                                btnConfirm.removeEventListener('click', onConfirm);
                                btnCancel.removeEventListener('click', onCancel);
                                modal.removeEventListener('click', onOverlay);
                            };
                            const onConfirm = () => { cleanup(); resolve(true); };
                            const onCancel = () => { cleanup(); resolve(false); };
                            const onOverlay = (e) => { if (e.target === modal) { cleanup(); resolve(false); } };
                            btnConfirm.addEventListener('click', onConfirm);
                            btnCancel.addEventListener('click', onCancel);
                            modal.addEventListener('click', onOverlay);
                        });
                    }

                    form.addEventListener('submit', async function (e) {
                        e.preventDefault();

                        showModal();
                        const ok = await awaitConfirm();
                        if (!ok) { hideModal(); return; }

                        const pin = pinInput.value.trim();
                        if (!pin) {
                            alert('Please enter your PIN');
                            hideModal();
                            return;
                        }

                        const fd = new FormData(form);
                        const payload = {
                            company: companyName,
                            title: fd.get('title'),
                            description: fd.get('description'),
                            pay: fd.get('pay'),
                            pin: pin
                        };

                        try {
                            btnConfirm.disabled = true;
                            btnConfirm.textContent = 'Processing...';

                            // Step 1: Process payment
                            const paymentResponse = await fetch('/transfer/job', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify(payload)
                            });

                            const paymentResult = await paymentResponse.json().catch(() => ({ success: false, message: 'Invalid response from payment server' }));

                            // If payment fails, redirect to job page without creating job
                            if (!paymentResponse.ok || !paymentResult.success) {
                                let errorMsg = 'Payment failed. Job was not posted.\n\n';
                                if (paymentResult.message) {
                                    errorMsg += paymentResult.message;
                                }
                                if (paymentResult.details && paymentResult.details.message) {
                                    errorMsg += '\n' + paymentResult.details.message;
                                }
                                alert(errorMsg);

                                // Redirect to company job page (job NOT created)
                                window.location.href = '/job/' + encodeURIComponent(companyName);
                                return;
                            }

                            // Step 2: Create job ONLY if payment succeeded
                            const createResponse = await fetch('/jobPosts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    company: companyName,
                                    title: payload.title,
                                    description: payload.description,
                                    pay: payload.pay,
                                    status: 'available',
                                    paymentVerified: 'true' // Security token
                                })
                            });

                            const createResult = await createResponse.json().catch(() => ({ success: false, message: 'Invalid response from server' }));

                            if (!createResponse.ok || !createResult.success) {
                                // Payment succeeded but job creation failed
                                alert('Payment processed but job posting failed: ' + (createResult.message || 'Unknown error') + '\nPlease contact support for refund.');
                                window.location.href = '/job/' + encodeURIComponent(companyName);
                                return;
                            }

                            // Success - redirect to company job page
                            alert('Job posted successfully!');
                            window.location.href = '/job/' + encodeURIComponent(companyName);

                        } catch (err) {
                            console.error('Error posting job:', err);
                            alert('Network error occurred. Job was not posted.\nPlease check your connection and try again.');

                            // Redirect to company job page on network error
                            window.location.href = '/job/' + encodeURIComponent(companyName);
                        }
                    });
                })();
            </script>
        </div>
    </div>

</body>

</html>