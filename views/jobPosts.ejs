<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Post</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
</head>
<body
  style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
  " class="post-job-page">
    <nav class="top-controls">
        <button onclick="location.href='/'" style="border: 1px solid <%= company.bsColor %>;">Home</button>
        <button onclick="location.href='/companies'" style="border: 1px solid <%= company.bsColor %>;">Companies</button>
        <button onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'" style="border: 1px solid <%= company.bsColor %>;">Job Page</button>
    </nav>

    <div class="container">
      <div class="post-card">
    <h1>Post a Job for <%= company.name %></h1>
        <form id="jobpost-form" action="/jobPosts" method="POST">
            <input type="hidden" name="company" value="<%= company.name %>">
            <div class="form-row">
                <label for="title">Job Title:</label>
                <input type="text" id="title" name="title" maxlength="100" required>
            </div>
            <div class="form-row">
                <label for="description">Description:</label>
                <textarea id="description" name="description" maxlength="200" required></textarea>
            </div>
            <div class="form-row">
                <label for="link">GitHub Issue Link:</label>
                <input type="url" id="link" name="link" required>
            </div>
            <div class="form-row">
                <label for="pay">Pay:</label>
                <input type="number" id="pay" name="pay" required>
            </div>
            <input type="hidden" name="status" value="available">
            <button type="submit" style="background-color: <%= company.pColor %>; color: <%= company.bpColor %>; border: 1px solid <%= company.bpColor %>;">Submit</button>
        </form>
        
        <!-- PIN modal -->
        <style>
        /* minimal modal styles kept local to this template */
        #pin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .pin-modal-content { background: linear-gradient(180deg,var(--bg-b),#3a1224); padding: 1.25rem; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.6); width: 360px; max-width: 92%; color: var(--muted); text-align: center; }
        .pin-modal-content h3{ margin: 0 0 0.5rem 0; }
        .pin-modal-content input { font-size: 1.15rem; padding: 0.6rem; width: 100%; margin: 0.6rem 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--muted); }
        .pin-actions{ display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem }
        .pin-actions button{ padding:0.45rem 0.8rem; border-radius:8px; border:none; cursor:pointer }
        #pin-cancel{ background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.04); }
        #pin-confirm{ background: var(--accent); color: #fff; }
        </style>

        <div id="pin-modal">
                <div class="pin-modal-content" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
                <h3 id="pin-modal-title">Cost: <%= typeof JPOST !== 'undefined' ? JPOST : 100 %></h3>
                <h3 id="pin-modal-title">Enter your PIN</h3>
                <input id="pin-input" type="password" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="••••••" autocomplete="one-time-code" />
                <div class="pin-actions">
                    <button id="pin-cancel" type="button">Cancel</button>
                    <button id="pin-confirm" type="button">Confirm</button>
                </div>
            </div>
        </div>

        <script>
            (function(){
                const form = document.getElementById('jobpost-form');
                if (!form) return;

                const modal = document.getElementById('pin-modal');
                const pinInput = document.getElementById('pin-input');
                const btnCancel = document.getElementById('pin-cancel');
                const btnConfirm = document.getElementById('pin-confirm');

                // allow Enter key in PIN field to confirm
                pinInput.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); btnConfirm.click(); } });

                let bypass = false;

                function showModal(){ pinInput.value = ''; modal.style.display = 'flex'; setTimeout(()=> pinInput.focus(), 50); }
                function hideModal(){ modal.style.display = 'none'; }

                async function awaitConfirm(){
                    return new Promise((resolve)=>{
                        const cleanup = ()=>{
                            btnConfirm.removeEventListener('click', onConfirm);
                            btnCancel.removeEventListener('click', onCancel);
                            modal.removeEventListener('click', onOverlay);
                        };
                        const onConfirm = ()=>{ cleanup(); resolve(true); };
                        const onCancel = ()=>{ cleanup(); resolve(false); };
                        const onOverlay = (e)=>{ if (e.target === modal) { cleanup(); resolve(false); } };
                        btnConfirm.addEventListener('click', onConfirm);
                        btnCancel.addEventListener('click', onCancel);
                        modal.addEventListener('click', onOverlay);
                    });
                }

                form.addEventListener('submit', async function(e){
                    if (bypass) return; // allow normal submit when bypass is true
                    e.preventDefault();

                    showModal();
                    const ok = await awaitConfirm();
                    if (!ok) { hideModal(); return; }

                    const pin = pinInput.value.trim();
                    if (!pin) { alert('Please enter your PIN'); return; }

                    const fd = new FormData(form);
                    const payload = {
                        company: fd.get('company'),
                        title: fd.get('title'),
                        description: fd.get('description'),
                        pay: fd.get('pay'),
                        pin: pin
                    };

                    try {
                        btnConfirm.disabled = true;
                        btnConfirm.textContent = 'Processing...';
                        const res = await fetch('/transfer/job', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json().catch(()=>({}));
                        if (res.ok && data && data.success) {
                            // proceed to submit the original form to /jobPosts to persist the job
                            bypass = true;
                            hideModal();
                            form.submit();
                        } else {
                            alert('Payment failed: ' + (data && data.message ? data.message : 'unknown'));
                        }
                    } catch(err) {
                        console.error('Payment error', err);
                        alert('Payment failed');
                    } finally {
                        btnConfirm.disabled = false;
                        btnConfirm.textContent = 'Confirm';
                    }
                });
            })();
        </script>
      </div>
    </div>

</body>
</html>