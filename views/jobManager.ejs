<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Manager - <%= company.name %></title>
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/job.css">
</head>

<body style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
">
  <main class="jobs-container">
    <div class="nav-row">
      <button class="small-btn" onclick="location.href='/companies'">All companies</button>
      <button class="small-btn" onclick="location.href='/allJobs'">All Jobs</button>
      <button class="small-btn" onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'">Job Page</button>
      <button class="small-btn" onclick="location.href='/jobPosts/<%= encodeURIComponent(company.name) %>'">Post a Job</button>
      <button class="small-btn" onclick="location.href='/edit/company/<%= company.id %>'">Edit Company</button>
    </div>

    <div class="jobs-header">
      <h1>Manage Jobs: <%= company ? company.name : 'Not found' %></h1>
      <% if (typeof message !== 'undefined' && message) { %>
        <div class="form-error" style="color:#ffd1d9;margin:0.5rem 0;padding:0.6rem;border-radius:6px;background:rgba(200,30,70,0.06);font-weight:700;">
          <%= message %>
        </div>
      <% } %>
    </div>

    <div class="jobs-columns">
      <!-- Available Jobs Column -->
      <section class="jobs-column">
        <h2>Available</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => !job.employee_id && !job.has_applications).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-link"><a href="<%= job.link %>" target="_blank">View Issue</a></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta available">Available</div>
                <button class="job-edit" onclick="location.href='/edit/job/<%= job.id %>'">Edit</button>
              </article>
            <% }) %>
          <% } else { %>
            <p>No available jobs</p>
          <% } %>
        </div>
      </section>
      <div class="VL"></div>

      <!-- Applied For Column -->
      <section class="jobs-column">
        <h2>Applied For</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.has_applications && !job.employee_id).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  <%= job.applicants_count %> applicant(s)
                  <% if (job.applicants && job.applicants.length > 0) { %>
                    <ul>
                      <% job.applicants.forEach(applicant => { %>
                        <li>
                          <%= applicant.name %>
                          <form action="/jobManager/accept" method="POST" style="display:inline;"
                            onsubmit="return confirm('Accept this applicant for the job?');">
                            <input type="hidden" name="jobId" value="<%= job.id %>">
                            <input type="hidden" name="applicantId" value="<%= applicant.fb_id %>">
                            <button type="submit" class="accept">Accept</button>
                          </form>
                        </li>
                      <% }) %>
                    </ul>
                  <% } %>
                </div>
                <button class="job-edit" onclick="location.href='/edit/job/<%= job.id %>'">Edit</button>
              </article>
            <% }) %>
          <% } else { %>
            <p>No applications yet</p>
          <% } %>
        </div>
      </section>
      <div class="VL"></div>

      <!-- In Progress Column -->
      <section class="jobs-column">
        <h2>In Progress</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.employee_id && job.status === 'in_progress').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  Assigned to <%= job.employee_name %>
                  <form action="/jobManager/fire/<%= job.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Fire this employee?');">
                    <button type="submit" class="fire">Fire</button>
                  </form>
                  <button class="complete-button" 
                    data-job-id="<%= job.id %>"
                    data-employee-id="<%= job.employee_id %>"
                    data-pay="<%= job.pay %>"
                    data-status="<%= job.status || '' %>"
                    data-title="<%= job.title %>">
                    Mark As Complete
                  </button>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No jobs in progress</p>
          <% } %>
        </div>
      </section>
      <div class="VL"></div>

      <!-- Completed Jobs Column -->
      <section class="jobs-column">
        <h2>Completed</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.status === 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta completed">Completed by <%= job.employee_name %></div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No completed jobs</p>
          <% } %>
        </div>
      </section>
    </div>
  </main>

  <!-- PIN Modal -->
  <div id="pin-modal">
    <div class="pin-modal-content" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
      <h3 id="pin-modal-title">Enter your PIN</h3>
      <input id="pin-input" type="password" maxlength="4" minlength="4" inputmode="numeric" pattern="[0-9]*"
        placeholder="••••" autocomplete="one-time-code" />
      <div class="pin-actions">
        <button id="pin-cancel" type="button">Cancel</button>
        <button id="pin-confirm" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Single consolidated script for Mark As Complete functionality -->
  <script>
  (function(){
    const modal = document.getElementById('pin-modal');
    if (!modal) return;

    const pinInput = document.getElementById('pin-input');
    const btnCancel = document.getElementById('pin-cancel');
    const btnConfirm = document.getElementById('pin-confirm');

    // Get company name from the page
    const companyName = '<%= company.name %>';

    let currentJobData = null;

    // Allow Enter key in PIN field to confirm
    if (pinInput) {
      pinInput.addEventListener('keydown', function(e){
        if (e.key === 'Enter') { e.preventDefault(); btnConfirm.click(); }
      });
    }

    function showModal(){
      if (pinInput) pinInput.value = '';
      modal.style.display = 'flex';
      setTimeout(() => { if (pinInput) pinInput.focus(); }, 50);
    }

    function hideModal(){
      modal.style.display = 'none';
      if (btnConfirm) {
        btnConfirm.disabled = false;
        btnConfirm.textContent = 'Confirm';
      }
    }

    function redirectToJobManager(message){
      if (message) alert(message);
      window.location.href = '/jobManager/' + encodeURIComponent(companyName);
    }

    async function awaitConfirm(){
      return new Promise((resolve) => {
        const cleanup = () => {
          btnConfirm.removeEventListener('click', onConfirm);
          btnCancel.removeEventListener('click', onCancel);
          modal.removeEventListener('click', onOverlay);
        };
        const onConfirm = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        const onOverlay = (e) => { if (e.target === modal) { cleanup(); resolve(false); } };
        btnConfirm.addEventListener('click', onConfirm);
        btnCancel.addEventListener('click', onCancel);
        modal.addEventListener('click', onOverlay);
      });
    }

    // Handle "Mark As Complete" button clicks
    document.querySelectorAll('.complete-button').forEach(button => {
      button.addEventListener('click', function () {
        currentJobData = {
          jobId: this.getAttribute('data-job-id'),
          employeeId: this.getAttribute('data-employee-id'),
          pay: this.getAttribute('data-pay'),
          title: this.getAttribute('data-title')
        };
        showModal();
      });
    });

    // Handle cancel button
    if (btnCancel) {
      btnCancel.addEventListener('click', function() {
        hideModal();
      });
    }

    // Handle confirm button
    if (btnConfirm) {
      btnConfirm.addEventListener('click', async function() {
        const pin = pinInput ? pinInput.value.trim() : '';
        if (!pin) { 
          alert('Please enter your PIN'); 
          return; 
        }

        if (!currentJobData) {
          alert('No job data available');
          return;
        }

        try {
          btnConfirm.disabled = true;
          btnConfirm.textContent = 'Processing...';

          // Step 1: Process payment/transfer
          const paymentResponse = await fetch('/transfer/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
              jobId: currentJobData.jobId,
              to: currentJobData.employeeId,
              amount: currentJobData.pay,
              reason: `Completed: ${currentJobData.title}`,
              pin: pin
            })
          });

          const paymentResult = await paymentResponse.json().catch(() => ({ success: false, message: 'Invalid response from payment server' }));

          // If payment fails, redirect without completing job
          if (!paymentResponse.ok || !paymentResult.success) {
            let errorMsg = 'Payment failed. Job was not marked as complete.\n\n';
            if (paymentResult.message) errorMsg += paymentResult.message;
            if (paymentResult.details && paymentResult.details.message) {
              errorMsg += '\n' + paymentResult.details.message;
            }
            return redirectToJobManager(errorMsg);
          }

          // Step 2: Mark job as complete ONLY if payment succeeded
          const completeResponse = await fetch('/jobManager/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
              jobId: currentJobData.jobId,
              paymentVerified: 'true' // Security token
            })
          });

          const completeResult = await completeResponse.json().catch(() => ({ success: false, message: 'Invalid response from server' }));

          if (!completeResponse.ok || !completeResult.success) {
            // Payment succeeded but database update failed
            return redirectToJobManager('Payment processed but job completion failed: ' + (completeResult.message || 'Unknown error') + '\nPlease contact support.');
          }

          // Success
          redirectToJobManager('Job marked as complete!');

        } catch (err) {
          console.error('Error completing job:', err);
          redirectToJobManager('Network error occurred. Job was not marked as complete.\nPlease check your connection and try again.');
        }
      });
    }
  })();
  </script>
</body>

</html>