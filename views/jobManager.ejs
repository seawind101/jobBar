<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Manager - <%= company.name %></title>
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/job.css">
</head>

<body style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
">
  <main class="jobs-container">
    <div class="nav-row">
      <button class="small-btn" onclick="location.href='/'">Home</button>
      <button class="small-btn" onclick="location.href='/companies'">All companies</button>
      <button class="small-btn" onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'">Job Page</button>
      <button class="small-btn" onclick="location.href='/jobPosts/<%= encodeURIComponent(company.name) %>'">Post a Job</button>
      <button class="small-btn" onclick="location.href='/edit/company'">Edit Company</button>
    </div>

    <div class="jobs-header">
      <h1>Manage Jobs: <%= company ? company.name : 'Not found' %></h1>
    </div>

    <div class="jobs-columns">
      <!-- Available Jobs Column -->
      <section class="jobs-column">
        <h2>Available</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => !job.employee_id && !job.has_applications).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-link"><a href="<%= job.link %>" target="_blank">View Issue</a></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta available">Available</div>
                <button onclick="location.href='/edit/job/<%= job.id %>'">Edit</button>
              </article>
            <% }) %>
          <% } else { %>
            <p>No available jobs</p>
          <% } %>
        </div>
      </section>

      <!-- Applied For Column -->
      <section class="jobs-column">
        <h2>Applied For</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.has_applications && !job.employee_id).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  <%= job.applicants_count %> applicant(s)
                  <% if (job.applicants && job.applicants.length > 0) { %>
                    <ul>
                      <% job.applicants.forEach(applicant => { %>
                        <li>
                          <%= applicant.name %>
                          <form action="/jobManager/accept" method="POST" style="display:inline;" onsubmit="return confirm('Accept this applicant for the job?');">
                            <input type="hidden" name="jobId" value="<%= job.id %>">
                            <input type="hidden" name="applicantId" value="<%= applicant.fb_id %>">
                            <button type="submit" class="accept">Accept</button>
                          </form>
                        </li>
                      <% }) %>
                    </ul>
                  <% } %>
                  <button onclick="location.href='/edit/job/<%= job.id %>'">Edit</button>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No applications yet</p>
          <% } %>
        </div>
      </section>

      <!-- In Progress Column -->
      <section class="jobs-column">
        <h2>In Progress</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.employee_id && job.status !== 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  Assigned to <%= job.employee_name %>
      <button class="complete-button" 
        data-job-id="<%= job.id %>"
        data-employee-id="<%= job.employee_id %>"
        data-pay="<%= job.pay %>"
        data-status="<%= job.status || '' %>"
        data-title="<%= job.title %>">
                    Mark As Complete
                  </button>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No jobs in progress</p>
          <% } %>
        </div>
      </section>

      <!-- Completed Jobs Column -->
      <section class="jobs-column">
        <h2>Completed</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.status === 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta completed">Completed by <%= job.employee_name %></div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No completed jobs</p>
          <% } %>
        </div>
      </section>
    </div>
  </main>

       <div id="pin-modal">
      <div class="pin-modal-content" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
        <h3 id="pin-cost">Pay them: 300</h3>
        <h3 id="pin-modal-title">Enter your PIN</h3>
                <input id="pin-input" type="password" maxlength="4" minlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="••••" autocomplete="one-time-code" />
                <div class="pin-actions">
                    <button id="pin-cancel" type="button">Cancel</button>
                    <button id="pin-confirm" type="button">Confirm</button>
                </div>
  </div>
  </div>

     <script>
            (function(){
                const form = document.getElementById('jobpost-form');
                if (!form) return;

                const modal = document.getElementById('pin-modal');
                const pinInput = document.getElementById('pin-input');
                const btnCancel = document.getElementById('pin-cancel');
                const btnConfirm = document.getElementById('pin-confirm');

                // allow Enter key in PIN field to confirm
                pinInput.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); btnConfirm.click(); } });

                let bypass = false;

                function showModal(){ pinInput.value = ''; modal.style.display = 'flex'; setTimeout(()=> pinInput.focus(), 50); }
                function hideModal(){ modal.style.display = 'none'; }

                async function awaitConfirm(){
                    return new Promise((resolve)=>{
                        const cleanup = ()=>{
                            btnConfirm.removeEventListener('click', onConfirm);
                            btnCancel.removeEventListener('click', onCancel);
                            modal.removeEventListener('click', onOverlay);
                        };
                        const onConfirm = ()=>{ cleanup(); resolve(true); };
                        const onCancel = ()=>{ cleanup(); resolve(false); };
                        const onOverlay = (e)=>{ if (e.target === modal) { cleanup(); resolve(false); } };
                        btnConfirm.addEventListener('click', onConfirm);
                        btnCancel.addEventListener('click', onCancel);
                        modal.addEventListener('click', onOverlay);
                    });
                }

                form.addEventListener('submit', async function(e){
                    if (bypass) return; // allow normal submit when bypass is true
                    e.preventDefault();

                    showModal();
                    const ok = await awaitConfirm();
                    if (!ok) { hideModal(); return; }

                    const pin = pinInput.value.trim();
                    if (!pin) { alert('Please enter your PIN'); return; }

                    const fd = new FormData(form);
                    const payload = {
                        company: fd.get('company'),
                        title: fd.get('title'),
                        description: fd.get('description'),
                        pay: fd.get('pay'),
                        pin: pin
                    };

                    try {
                        btnConfirm.disabled = true;
                        btnConfirm.textContent = 'Processing...';
                        const res = await fetch('/transfer/job', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json().catch(()=>({}));
                        if (res.ok && data && data.success) {
                            // proceed to submit the original form to /jobPosts to persist the job
                            bypass = true;
                            hideModal();
                            form.submit();
                        } else {
                            alert('Payment failed: ' + (data && data.message ? data.message : 'unknown'));
                        }
                    } catch(err) {
                        console.error('Payment error', err);
                        alert('Payment failed');
                    } finally {
                        btnConfirm.disabled = false;
                        btnConfirm.textContent = 'Confirm';
                    }
                    });
                  })();
                </script>

              <!-- Job Manager: wire Mark As Complete buttons to the shared PIN modal -->
              <script>
              (function(){
                const modal = document.getElementById('pin-modal');
                if (!modal) { console.warn('JobManager: pin-modal not found'); return; }
                const pinInput = document.getElementById('pin-input');
                const btnCancel = document.getElementById('pin-cancel');
                const btnConfirm = document.getElementById('pin-confirm');

                function showModal(){
                  if (!pinInput) return;
                  pinInput.value = '';
                  modal.style.display = 'flex';
                  setTimeout(()=> pinInput.focus(), 40);
                }
                function hideModal(){ modal.style.display = 'none'; }

                function awaitConfirm(){
                  return new Promise((resolve)=>{
                    const cleanup = ()=>{
                      btnConfirm.removeEventListener('click', onConfirm);
                      btnCancel.removeEventListener('click', onCancel);
                      modal.removeEventListener('click', onOverlay);
                    };
                    const onConfirm = ()=>{ cleanup(); resolve(true); };
                    const onCancel = ()=>{ cleanup(); resolve(false); };
                    const onOverlay = (e)=>{ if (e.target === modal) { cleanup(); resolve(false); } };
                    btnConfirm.addEventListener('click', onConfirm);
                    btnCancel.addEventListener('click', onCancel);
                    modal.addEventListener('click', onOverlay);
                  });
                }

                // Delegate clicks for complete buttons
                document.addEventListener('click', async function(ev){
                  const btn = ev.target.closest && ev.target.closest('.complete-button');
                  if (!btn) return;
                  ev.preventDefault();

                  const jobId = btn.getAttribute('data-job-id');
                  const employeeId = btn.getAttribute('data-employee-id');
                  const pay = btn.getAttribute('data-pay');
                  const status = btn.getAttribute('data-status') || '';
                  const title = btn.getAttribute('data-title') || '';

                  // Only allow completing jobs that are officially in_progress (owner must accept applicant first)
                  if (status !== 'in_progress') { alert('Only in-progress jobs can be marked complete.'); return; }
                  if (!jobId || !employeeId) { alert('Missing job info. Refresh and try again.'); return; }

                  // update cost display to reflect this job's pay
                  try {
                    const costEl = document.getElementById('pin-cost');
                    if (costEl) costEl.textContent = 'Complete Job Cost: ' + (pay || '0');
                  } catch (e) { /* ignore */ }

                  showModal();
                  const ok = await awaitConfirm();
                  if (!ok) { hideModal(); return; }

                  const pin = pinInput ? pinInput.value.trim() : '';
                  if (!pin) { alert('Please enter your PIN'); return; }

                  // disable confirm while processing
                  btnConfirm.disabled = true;
                  const prevText = btnConfirm.textContent;
                  btnConfirm.textContent = 'Processing...';

                  try {
                    const res = await fetch('/transfer/complete', {
                      method: 'POST',
                      credentials: 'same-origin',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ jobId: jobId, to: employeeId, amount: pay, reason: `Completed ${title}`, pin })
                    });
                    const data = await res.json().catch(()=>({}));
                    if (res.ok && data && data.success) {
                      hideModal();
                      window.location.reload();
                    } else {
                      alert('Transfer failed: ' + (data && data.message ? data.message : 'unknown'));
                      // show modal again so user can retry
                      showModal();
                    }
                  } catch(err) {
                    console.error('Transfer error', err);
                    alert('Transfer error');
                    showModal();
                  } finally {
                    btnConfirm.disabled = false;
                    btnConfirm.textContent = prevText;
                  }
                });
              })();
              </script>
</body>

</html>