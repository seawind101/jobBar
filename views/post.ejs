<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
</head>

<body class="create-company-page">
    <nav class="top-controls">
        <button onclick="location.href='/'">Home</button>
        <button onclick="location.href='/companies'">Companies</button>
    </nav>

    <div class="container">
        <div class="post-card">
            <h1>Post your Company</h1>
            <% if (typeof error !=='undefined' && error) { %>
                <div class="form-error" style="color:#ffd1d9;margin-bottom:0.75rem;font-weight:700;">
                    <%= error %>
                </div>
                <% } %>
                    <form id="company-form" action="/post" method="POST">
                        <div class="form-row">
                            <label for="name">Company Name:</label>
                            <input type="text" id="name" name="name" required
                                value="<%= form && form.name ? form.name : '' %>">
                        </div>
                        <div class="form-row">
                            <label for="description">Description:</label>
                            <textarea id="description" name="description"
                                required><%= form && form.description ? form.description : '' %></textarea>
                        </div>
                        <div class="form-row">
                            <label for="link">Website URL:</label>
                            <input type="url" id="link" name="link" required
                                value="<%= form && form.link ? form.link : '' %>">
                        </div>
                        <div class="color-row">
                            <label for="pColor">Primary Color:</label>
                            <input type="color" id="pColor" name="pColor"
                                value="<%= form && form.pColor ? form.pColor : '#000000' %>" class="color-input">
                        </div>
                        <div class="color-row">
                            <label for="sColor">Secondary Color:</label>
                            <input type="color" id="sColor" name="sColor"
                                value="<%= form && form.sColor ? form.sColor : '#ffffff' %>" class="color-input">
                        </div>
                        <input type="hidden" name="owner_id" value="<%= fb_id %>">
                        <input type="hidden" id="bpColor" name="bpColor" value="#ffffff">
                        <input type="hidden" id="bsColor" name="bsColor" value="#000000">
                        <button type="submit">Submit</button>
                    </form>

                    <!-- PIN modal -->
                    <style>
                    /* minimal modal styles kept local to this template */
                    #pin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
                    .pin-modal-content { background: linear-gradient(180deg,var(--bg-b),#3a1224); padding: 1.25rem; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.6); width: 360px; max-width: 92%; color: var(--muted); text-align: center; }
                    .pin-modal-content h3{ margin: 0 0 0.5rem 0; }
                    .pin-modal-content input { font-size: 1.15rem; padding: 0.6rem; width: 100%; margin: 0.6rem 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--muted); }
                    .pin-actions{ display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem }
                    .pin-actions button{ padding:0.45rem 0.8rem; border-radius:8px; border:none; cursor:pointer }
                    #pin-cancel{ background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.04); }
                    #pin-confirm{ background: var(--accent); color: #fff; }
                    </style>

                    <div id="pin-modal">
                        <div class="pin-modal-content" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
                                    <h3 id="pin-modal-title">Cost: <%= typeof CPOST !== 'undefined' ? CPOST : 300 %></h3>
                            <h3 id="pin-modal-title">Enter your PIN</h3>
                            <input id="pin-input" type="password" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="••••••" autocomplete="one-time-code" />
                            <div class="pin-actions">
                                <button id="pin-cancel" type="button">Cancel</button>
                                <button id="pin-confirm" type="button">Confirm</button>
                            </div>
                        </div>
                    </div>

                    <script>
                        (function(){
                            const form = document.getElementById('company-form');
                            if (!form) return;

                            const modal = document.getElementById('pin-modal');
                            const pinInput = document.getElementById('pin-input');
                            const btnCancel = document.getElementById('pin-cancel');
                            const btnConfirm = document.getElementById('pin-confirm');

                            // allow Enter key in PIN field to confirm
                            pinInput.addEventListener('keydown', function(e){
                                if (e.key === 'Enter') { e.preventDefault(); btnConfirm.click(); }
                            });

                            let bypass = false;

                            function showModal(){
                                pinInput.value = '';
                                modal.style.display = 'flex';
                                setTimeout(()=> pinInput.focus(), 50);
                            }
                            function hideModal(){
                                modal.style.display = 'none';
                            }

                            async function awaitConfirm(){
                                return new Promise((resolve)=>{
                                    const cleanup = ()=>{
                                        btnConfirm.removeEventListener('click', onConfirm);
                                        btnCancel.removeEventListener('click', onCancel);
                                        modal.removeEventListener('click', onOverlay);
                                    };
                                    const onConfirm = ()=>{ cleanup(); resolve(true); };
                                    const onCancel = ()=>{ cleanup(); resolve(false); };
                                    const onOverlay = (e)=>{ if (e.target === modal) { cleanup(); resolve(false); } };
                                    btnConfirm.addEventListener('click', onConfirm);
                                    btnCancel.addEventListener('click', onCancel);
                                    modal.addEventListener('click', onOverlay);
                                });
                            }

                            form.addEventListener('submit', async function(e){
                                if (bypass) return; // allow normal submit when bypass is true
                                e.preventDefault();

                                showModal();
                                const ok = await awaitConfirm();
                                if (!ok) { hideModal(); return; }

                                const pin = pinInput.value.trim();
                                if (!pin) { alert('Please enter your PIN'); return; }

                                const fd = new FormData(form);
                                const payload = {
                                    name: fd.get('name'),
                                    description: fd.get('description'),
                                    link: fd.get('link'),
                                    pin: pin
                                };

                                try {
                                    btnConfirm.disabled = true;
                                    btnConfirm.textContent = 'Processing...';
                                    const res = await fetch('/transfer/company', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'same-origin',
                                        body: JSON.stringify(payload)
                                    });
                                    const data = await res.json().catch(()=>({}));
                                    if (res.ok && data && data.success) {
                                        // proceed to submit the original form to /post to persist company
                                        bypass = true;
                                        hideModal();
                                        form.submit();
                                    } else {
                                        alert('Payment failed: ' + (data && data.message ? data.message : 'unknown'));
                                    }
                                } catch(err) {
                                    console.error('Payment error', err);
                                    alert('Payment failed');
                                } finally {
                                    btnConfirm.disabled = false;
                                    btnConfirm.textContent = 'Confirm';
                                }
                            });
                        })();
                    </script>
        </div>
    </div>
</body>
<script>
    // Function to calculate brightness and return appropriate text color
    function getTextColor(hexColor) {
        // Remove # if present
        const hex = hexColor.replace('#', '');

        // Convert to RGB
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);

        // Calculate relative luminance (perceived brightness)
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;

        // Return black for bright colors, white for dark colors
        return brightness > 128 ? '#000000' : '#ffffff';
    }

    // Update text color based on background color
    function updateTextColor(colorInputId, textColorInputId) {
        const colorInput = document.getElementById(colorInputId);
        const textColorInput = document.getElementById(textColorInputId);
        const color = colorInput.value;
        textColorInput.value = getTextColor(color);
    }

    // Event listeners for color inputs
    document.getElementById('pColor').addEventListener('input', function () {
        updateTextColor('pColor', 'bpColor');
    });

    document.getElementById('sColor').addEventListener('input', function () {
        updateTextColor('sColor', 'bsColor');
    });

    // Initialize text colors on page load
    updateTextColor('pColor', 'bpColor');
    updateTextColor('sColor', 'bsColor');
</script>

</html>